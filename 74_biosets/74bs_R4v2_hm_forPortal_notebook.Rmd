---
title: "74 biosets heatmap using R4v2 data"
author: "Chase McFarland"
output: html_notebook
---

```{r}
## Check if required CRAN packages are installed, and install if not
cran_packages = c("gplots", "gtools",
                  "RColorBrewer", "dplyr","BiocManager","shiny", "heatmaply")

#Now load or install/load all
cran.package.check <- lapply(
  cran_packages,
  FUN = function(x) {
    if (!require(x, character.only = TRUE)) {
      install.packages(x, dependencies = TRUE)
      library(x, character.only = TRUE)
    }
  }
)

## Repeat for required bioconductor packages

bioc_packages = c("ComplexHeatmap", "InteractiveComplexHeatmap")

bioc.package.check <- lapply(
  bioc_packages,
  FUN = function(x) {
    if (!require(x, character.only = TRUE)) {
      BiocManager::install(x, dependencies = TRUE)
      library(x, character.only = TRUE)
    }
  }
)

```


```{r}
#import raw data table as a data frame as well as list of previously sorted 4-5 timepoint genes
rawData = read.csv("SARS-CoV_Round4v2_74Biosets.csv", sep=",", header=T, check.names = FALSE)
rawData = as.data.frame(rawData)
sortedGenes = read.csv("3Bv4_4-5TP_genes.csv", sep=",", header = F, check.names = FALSE)
```


```{r}
#extract gene columns from raw data by name list of sorted genes
geneList = sortedGenes[,1] #saves all genes as a character vector
hmData = rawData %>%
            select(all_of(geneList)) 
rownames(hmData) <- rawData[,1] #sets row names of parsed data frame to bioset id's
```


```{r}

#build sorting script for highlighting biosets by DPI
dpiColors <- unlist(lapply(rownames(hmData),function(x){
  if(grepl("867451|867454|867457|867478|867481|867484",x)) '#E41A1C' #0.5 DPI
  else if(grepl("926614|494014|494017|494020|494023|867460|867463|867466|867487|867490|867493|821644|823390|839425|839437",x)) '#377EB8' #1 DPI
  else if(grepl("926620|494026|494029|494032|494035|867469|867472|867475|867496|867499|867502|821650|823396|839428|839440|833449|1326109|957616|995281",x)) '#4DAF4A' #2 DPI
  else if(grepl("494038|494041|494044|494047|867505|867508|867511|685244|685187|685193|821656|823402|839431|839443|833452|840316|834109|957619|995284",x)) '#984EA3' #4 DPI
  else if(grepl("494050|494053|494056|494011|685247|685178|685217|821662|823408|839434|839446|833455|840319|834112|995287",x)) '#FF7F00' #7 DPI
}))

#build sorting script for highlighting biosets by SARS strain
strainColors <- unlist(lapply(rownames(hmData),function(x){
  if(grepl("867451|867478|494014|494017|494020|494023|867460|867487|821644|823390|839437|494026|494029|494032|494035|867469|867496|821650|823396|839440|833449|1326109|957616|995281|494038|494041|494044|494047|867505|685244|685187|685193|821656|823402|839443|833452|840316|834109|957619|995284|494050|494053|494056|494011|685247|685178|685217|821662|823408|839446|833455|840319|834112|995287", x)) '#66C2A5' #MA15
  else if(grepl("867457|867484|867466|867493|867475|867502|867511", x)) '#Fc8D62' #MA15g
  else if(grepl("867454|867481|867463|867490|867472|867499|867508", x)) '#8DA0CB' #MA15e
  else if(grepl("926614|926620", x)) '#E78AC3' #TOR-2
  else if(grepl("839425|839428|839431|839434", x)) '#A6D854' #ic
}))

#build sorting script for highlighting biosets by mouse age
ageColors <- unlist(lapply(rownames(hmData),function(x){
  if(grepl("867451|867460|867469|867457|867466|867475|867454|867463|867472", x)) '#8DD3C7' #old 52wk
  else if(grepl("494014|494017|494020|494023|821644|823390|839437|494026|494029|494032|494035|821650|823396|839440|494038|494041|494044|494047|821656|823402|839443|833452|840316|834109|494050|494053|494056|494011|821662|823408|839446|840319|834112|839425|839428|839431|839434", x)) '#FFFFB3' #mid 20-23wk
  else if(grepl("867478|867487|867496|833449|1326109|957616|995281|867505|685244|685187|685193|957619|995284|685247|685178|685217|833455|995287|867484|867493|867502|867511|867481|867490|867499|867508|926614|926620", x)) '#BEBADA' #young <10wk
}))

#build sorting script for highlighting biosets by dose
doseColors <- unlist(lapply(rownames(hmData), function(x){
  if(grepl("867451|867454|867457|867478|867481|867484|494023|867460|867463|867466|867487
|867490|867493|821644|823390|839437|494035|867469|867472|867475|867496|867499
|867502|821650|823396|839440|833449|1326109|494047|867505|867508|867511|685244
|685187|685193|821656|823402|839443|833452|834109|494011|685247|685178|685217
|821662|823408|839446|833455|834112", x)) '#1B9E77' #100,000 PFU
  else if(grepl("926614|926620", x)) '#D95F02' #22,000 PFU
  else if(grepl("494020|839425|494032|839428|957616|995281|494044|839431|840316|957619|995284|494056
|839434|840319|995287", x)) '#7570B3' #10,000 PFU
  else if(grepl("494017|494029|494041|494053", x)) '#E7298A' #1,000 PFU
  else if(grepl("494014|494026|494038|494050", x)) '#2062F9' #100 PFU
}))
```


```{r}
#bind highlight schema to one dataframe and name columns respectively
annotCols=cbind(dpiColors,strainColors,ageColors,doseColors)
colnames(annotCols)[1]="DPI"
colnames(annotCols)[2]="SARS Variant"
colnames(annotCols)[3]="Age"
colnames(annotCols)[4]="Viral Dose [PFU]"
```


```{r}
#transpose hmData so biosets are along x axis and genes are along y axis
hmData_t = t(hmData)
```


```{r}
#create yellow-black-blue color palette
yeBlBuPal = colorRampPalette(c("blue","blue2","blue3","blue4","black","yellow4","yellow3","yellow2","yellow"))
```


```{r}
#generate static heatmap to obtain reference row and column dendrograms
hm = heatmap.2(hmData_t, col=yeBlBuPal(27), scale=c("none"), trace = c("none"))

#generates as an exact inverse of previous heatmaps so get the dendrograms and flip them
hm_rowv <- hm$rowDendrogram
hm_rowv <- rev(hm_rowv) 

hm_colv <- hm$colDendrogram
hm_colv <- rev(hm_colv)
```


```{r}
#interactive ComplexHeatmap version 
library(ComplexHeatmap)
library(InteractiveComplexHeatmap)

ich_annot <- HeatmapAnnotation(df = as.data.frame(annotCols)) #ICH requres a special annotation object

hm3 = Heatmap(hmData_t, cluster_rows = hm_rowv, cluster_columns = rev(hm_colv), col = yeBlBuPal(27), top_annotation = ich_annot)
hm3 = draw(hm3)

ht_shiny(hm3)
```

